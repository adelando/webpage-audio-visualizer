<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VISUALIZER V17.6.2 - by Adelando</title>
    <style>
        :root { --panel-bg: rgba(10, 10, 15, 0.98); --accent: #00fbff; --mic-accent: #00ff88; --border: rgba(255,255,255,0.1); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Segoe UI', system-ui, sans-serif; color: white; }
        canvas { display: block; }
        #toggle-btn { position: absolute; top: 20px; left: 20px; background: var(--panel-bg); border: 1px solid var(--border); color: white; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 20px; z-index: 100; display: flex; align-items: center; justify-content: center; transition: all 0.4s; box-shadow: 0 4px 15px rgba(0,0,0,0.4); opacity: 0.3; }
        #toggle-btn:hover { opacity: 1; transform: scale(1.1); }
        #toggle-btn.active { left: 335px; opacity: 1; } 
        #ui-layer { position: absolute; top: 20px; left: 20px; background: var(--panel-bg); backdrop-filter: blur(25px); border: 1px solid var(--border); border-radius: 12px; width: 360px; z-index: 10; transition: transform 0.4s, opacity 0.3s; box-shadow: 0 15px 35px rgba(0,0,0,0.6); }
        #ui-layer.hidden { transform: translateX(-400px); opacity: 0; pointer-events: none; }
        .header { padding: 18px 18px 2px 18px; font-weight: 800; font-size: 0.85rem; letter-spacing: 1.5px; text-transform: uppercase; color: var(--accent); }
        .tagline { padding: 0 18px 10px 18px; font-size: 0.65rem; opacity: 0.6; font-style: italic; line-height: 1.3; }
        .controls { padding: 15px 20px 20px 20px; display: flex; flex-direction: column; gap: 16px; max-height: 75vh; overflow-y: auto; }
        .controls::-webkit-scrollbar { width: 5px; }
        .controls::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
        .control-group { display: flex; flex-direction: column; gap: 6px; }
        .label-row { display: flex; justify-content: space-between; align-items: center; }
        .val { color: var(--accent); font-family: monospace; font-size: 0.85rem; font-weight: bold; }
        label { font-size: 0.62rem; text-transform: uppercase; opacity: 0.5; letter-spacing: 1.5px; font-weight: 700; }
        input[type="range"] { flex-grow: 1; accent-color: var(--accent); cursor: pointer; height: 4px; }
        input[type="text"], select, button, textarea { background: #1a1a20; color: white; border: 1px solid #333; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 0.75rem; }
        .primary-btn { background: var(--accent) !important; color: black !important; font-weight: 800; border: none !important; margin-bottom: 5px; }
        .mic-btn { background: var(--mic-accent) !important; color: black !important; font-weight: 800; border: none !important; }
        .reset-btn { background: #ff4444 !important; color: white !important; font-weight: 800; border: none !important; margin-top: 10px; display: none; }
        details { background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid var(--border); margin-top: 5px; }
        summary { padding: 10px; font-size: 0.65rem; text-transform: uppercase; cursor: pointer; font-weight: bold; color: var(--accent); }
        .details-content { padding: 10px 15px 15px 15px; font-size: 0.7rem; line-height: 1.4; color: #ccc; }
        .details-content b { color: var(--accent); }
        .info-text { font-size: 0.6rem; opacity: 0.6; margin-top: 8px; line-height: 1.2; }
        .history-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 10px; }
        .hist-slot { background: #1a1a20; border: 1px solid #333; padding: 8px 4px; text-align: center; border-radius: 6px; font-size: 0.6rem; cursor: pointer; transition: 0.2s; }
        .hist-slot:hover { border-color: var(--accent); background: #252530; }
        .hist-slot.filled { border-color: var(--accent); color: var(--accent); box-shadow: inset 0 0 5px rgba(0,251,255,0.2); }
        .gh-link { color: var(--accent); text-decoration: none; font-weight: bold; border-bottom: 1px solid var(--accent); }
        .shortcut-list { font-size: 0.55rem; color: #888; margin-top: 5px; display: grid; grid-template-columns: 1fr 1fr; }
    </style>
</head>
<body>

    <button id="toggle-btn" class="active">‚öôÔ∏è</button>

    <div id="ui-layer">
        <div class="header">V17.6.2</div>
        <div class="tagline">Created by: Adelando</div>
        
        <div class="controls">
            <div class="control-group">
                <label>Shape Mode</label>
                <select id="baseShape">
                    <option value="moons" selected>üõ∞Ô∏è Orbiting Moons</option>
                    <option value="neural">üß† Neural Web</option>
                    <option value="text">üî† Custom Text</option>
                    <option value="kaleidoscope">üç≠Kaleidoscope Bars</option>
                    <option value="triangle">üî∫Geometric Triangles</option>
                    <option value="hexagon">üîπPulsing Hexagons</option>
                    <option value="circle">üîòConcentric Circles</option>
                    <option value="square">‚ñ™Ô∏èNested Squares</option>
                    <option value="horizontal">üìäMirror Bar</option>
                    <option value="waveform">üîâWaveform</option>
                </select>
            </div>

            <div class="control-group" id="text-input-container" style="display:none;">
                <label>Visualizer Text</label>
                <input type="text" id="customText" value="‚äÇ(‚óâ‚Äø‚óâ)„Å§">
            </div>
            
            <div class="control-group">
                <div class="label-row"><label>Gain / Sensitivity</label><span class="val" id="val-sensitivity">1.0</span></div>
                <input type="range" id="sensitivity" min="0.1" max="10.0" step="0.1" value="1.0">
            </div>

            <div class="control-group">
                <div class="label-row"><label>Base Spacing</label><span class="val" id="val-barSpacing">10</span></div>
                <input type="range" id="barSpacing" min="1" max="100" step="1" value="10">
            </div>

            <div class="control-group">
                <div class="label-row"><label>Line Thickness</label><span class="val" id="val-thickness">2.0</span></div>
                <input type="range" id="thickness" min="0.5" max="15.0" step="0.5" value="2.0">
            </div>

            <div class="control-group">
                <div class="label-row"><label>Complexity</label><span class="val" id="val-slices">25</span></div>
                <input type="range" id="slices" min="2" max="100" value="25">
            </div>

            <div class="control-group">
                <div class="label-row"><label>Rotation</label><span class="val" id="val-rotation">0.004</span></div>
                <input type="range" id="rotation" min="-0.05" max="0.05" step="0.001" value="0.004">
            </div>

            <div class="control-group">
                <div class="label-row"><label>Master Zoom</label><span class="val" id="val-zoom">1.5</span></div>
                <input type="range" id="zoom" min="0.2" max="5.0" step="0.1" value="1.5">
            </div>

            <div class="control-group">
                <div class="label-row"><label>Decay (Trails)</label><span class="val" id="val-decay">0.50</span></div>
                <input type="range" id="decay" min="0.01" max="1.0" step="0.01" value="0.50">
            </div>

            <div class="control-group">
                <div class="label-row"><label>Mirror Flip (Invert)</label><input type="checkbox" id="mirrorFlip" style="width:18px;height:18px;accent-color:var(--accent);"></div>
            </div>

            <details>
                <summary>üé® COLOR & BACKGROUND</summary>
                <div class="details-content">
                    <div class="control-group">
                        <label>Color Mode</label>
                        <select id="colorMode">
                            <option value="rainbow">Full Rainbow</option>
                            <option value="custom">Custom Palette</option>
                            <option value="cyber">Cyberpunk</option>
                            <option value="voltage">High Voltage</option>
                            <option value="midnight">Midnight</option>
                            <option value="lava">Lava Flow</option>
                        </select>
                    </div>
                    <div class="control-group" style="margin-top:10px;">
                        <div class="label-row"><label>Color Speed</label><span class="val" id="val-rainbowSpeed">1.0</span></div>
                        <input type="range" id="rainbowSpeed" min="0" max="10" step="0.1" value="1.0">
                    </div>
                    <div id="custom-colors-container" class="control-group" style="display:none; margin-top:10px;">
                        <label>Custom Palette Colors</label>
                        <div style="display:flex; gap:10px;">
                            <input type="color" id="color1" value="#00fbff" style="width:50%;height:35px;background:none;border:none;cursor:pointer;">
                            <input type="color" id="color2" value="#ff00ff" style="width:50%;height:35px;background:none;border:none;cursor:pointer;">
                        </div>
                    </div>
                    <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">
                    <div class="control-group">
                        <label>Background Color</label>
                        <input type="color" id="bgColor" value="#000000" style="width:100%;height:35px;background:none;border:none;cursor:pointer;">
                    </div>
                    <div class="control-group" style="margin-top:10px;">
                        <div class="label-row"><label>Reactive Background</label><input type="checkbox" id="reactiveBG" style="width:18px;height:18px;accent-color:var(--accent);"></div>
                        <div class="info-text">Flashes the background color to the beat.</div>
                    </div>
                </div>
            </details>

            <details>
                <summary>üåê AUDIO SETUP GUIDE</summary>
                <div class="details-content">
                    <button class="primary-btn" id="capture-btn" style="width:100%">SYSTEM AUDIO CAPTURE</button>
                    <button class="mic-btn" id="mic-btn" style="width:100%">MICROPHONE INPUT</button>
                    <div style="margin-top:15px;">
                        <b>Chromium (Chrome/Edge/Opera):</b><br>
                        1. Click System Audio Capture.<br>
                        2. Select <u>Tab</u> or <u>Entire Screen</u>.<br>
                        3. Ensure <b>"Also share tab audio"</b> toggle is **<b>ON</b>**.<br><br>
                        <b>Mobile/Other:</b><br>
                        Use <b>Microphone Input</b> to react to ambient sound.
                    </div>
                </div>
            </details>

            <details>
                <summary>üíæ PRESETS & DATA</summary>
                <div class="details-content">
                    <div class="history-grid">
                        <div id="slot-0" class="hist-slot" onclick="saveToHistory(0)">SAVE 1</div>
                        <div id="slot-1" class="hist-slot" onclick="saveToHistory(1)">SAVE 2</div>
                        <div id="slot-2" class="hist-slot" onclick="saveToHistory(2)">SAVE 3</div>
                        <div id="slot-3" class="hist-slot" onclick="saveToHistory(3)">SAVE 4</div>
                        <div id="slot-4" class="hist-slot" onclick="saveToHistory(4)">SAVE 5</div>
                        <div id="slot-5" class="hist-slot" onclick="saveToHistory(5)">SAVE 6</div>
                        <div id="slot-6" class="hist-slot" onclick="saveToHistory(6)">SAVE 7</div>
                        <div id="slot-7" class="hist-slot" onclick="saveToHistory(7)">SAVE 8</div>
                        <div id="slot-8" class="hist-slot" onclick="saveToHistory(8)">SAVE 9</div>
                    </div>
                    <div class="info-text"><b>Tip:</b> Press number keys <b>[1-9]</b> to load slots.</div>
                    <textarea id="preset-data" style="width:100%; height:60px; font-size:0.65rem; margin-top:15px; color:#00fbff;" placeholder="Export/Import code..."></textarea>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <button id="export-btn" style="flex:1;">EXPORT</button>
                        <button id="import-btn" style="flex:1;" class="primary-btn">IMPORT</button>
                    </div>
                    <div class="info-text"><b>Export:</b> Generates a code. <br><b>Import:</b> Replaces current settings.</div>
                </div>
            </details>

            <details>
                <summary>üõ†Ô∏è PROJECT INFO</summary>
                <div class="details-content">
                    High-fidelity audio reactive tool designed to produce amazing visual displays that are extremely customisable.
                    <br></b>
                    <b>Keyboard Shortcuts:</b><br>
                    <div class="info-text"><b>[Key] + (‚¨ÖÔ∏è‚û°Ô∏è‚¨ÜÔ∏è‚¨áÔ∏è) keys</b></div>
                    <div class="shortcut-list">
                        <span><div class="info-text"><b>G + ‚¨ÖÔ∏è‚û°Ô∏è‚¨ÜÔ∏è‚¨áÔ∏è:</b></div> Gain</span>
                        <span><div class="info-text"><b>S + ‚¨ÖÔ∏è‚û°Ô∏è‚¨ÜÔ∏è‚¨áÔ∏è:</b></div> Spacing</span>
                        <span><div class="info-text"><b>T + ‚¨ÖÔ∏è‚û°Ô∏è‚¨ÜÔ∏è‚¨áÔ∏è:</b></div> Thickness</span>
                        <span><div class="info-text"><b>C + ‚¨ÖÔ∏è‚û°Ô∏è‚¨ÜÔ∏è‚¨áÔ∏è:</b></div> Complexity</span>
                        <span><div class="info-text"><b>R + ‚¨ÖÔ∏è‚û°Ô∏è‚¨ÜÔ∏è‚¨áÔ∏è:</b></div> Rotation</span>
                        <span><div class="info-text"><b>Z + ‚¨ÖÔ∏è‚û°Ô∏è‚¨ÜÔ∏è‚¨áÔ∏è:</b></div> Zoom</span>
                        <span><div class="info-text"><b>D + ‚¨ÖÔ∏è‚û°Ô∏è‚¨ÜÔ∏è‚¨áÔ∏è:</b></div> Decay</span>
                        <span><div class="info-text"><b>F:</b></div> Toggle Flip</span>
                        <span><div class="info-text"><b>Q:</b></div> Toggle Reset</span>
                        <span><div class="info-text"><b>1-9 Numbers:</b></div> Load Presets</span>
                    </div>
                    <br>
                    <a href="https://github.com/adelando/webpage-audio-visualizer" target="_blank" class="gh-link">View on GitHub</a>
                </div>
            </details>

            <button id="master-reset" class="reset-btn">RESET SLIDERS TO DEFAULT</button>
        </div>
    </div>

    <canvas id="visualizer"></canvas>

    <script>
        const canvas = document.getElementById('visualizer'), ctx = canvas.getContext('2d'), ui = document.getElementById('ui-layer'), btn = document.getElementById('toggle-btn');
        let audioCtx, analyser, dataArray, timeData, isStarted = false, currentStream, globalRotation = 0, autoHue = 0;
        
        const DEFAULTS = {
            sensitivity: 1.0, barSpacing: 10, thickness: 2.0, slices: 25, 
            rotation: 0.004, zoom: 1.5, decay: 0.50, mirrorFlip: false,
            rainbowSpeed: 1.0, bgColor: '#000000', reactiveBG: false
        };

        let settings = { ...DEFAULTS, baseShape: 'moons', colorMode: 'rainbow', color1: '#00fbff', color2: '#ff00ff', customText: '‚äÇ(‚óâ‚Äø‚óâ)„Å§' };
        let stars = [], nodes = [], history = new Array(9).fill(null), activeKeys = {};

        function initStars() {
            stars = [];
            if(settings.baseShape === 'moons') 
                for(let i=0; i<400; i++) stars.push({ x: Math.random()*2-1, y: Math.random()*2-1, z: Math.random(), orbit: Math.random()*Math.PI*2 });
        }

        function initNodes() {
            nodes = [];
            if(settings.baseShape === 'neural') {
                const count = parseInt(settings.slices);
                for(let i=0; i<count; i++) nodes.push({ x: (Math.random()-0.5)*600, y: (Math.random()-0.5)*600, vx: (Math.random()-0.5)*0.4, vy: (Math.random()-0.5)*0.4 });
            }
        }

        function checkUIState() {
            const hasChanged = Object.keys(DEFAULTS).some(k => settings[k] != DEFAULTS[k]);
            document.getElementById('master-reset').style.display = hasChanged ? 'block' : 'none';
            document.getElementById('text-input-container').style.display = (settings.baseShape === 'text') ? 'flex' : 'none';
            document.getElementById('custom-colors-container').style.display = (settings.colorMode === 'custom') ? 'flex' : 'none';
        }

        function applySettings(obj) {
            Object.assign(settings, obj);
            Object.keys(settings).forEach(k => {
                const el = document.getElementById(k);
                if(el) { el.type === 'checkbox' ? el.checked = settings[k] : el.value = settings[k]; }
                if(document.getElementById(`val-${k}`)) document.getElementById(`val-${k}`).innerText = settings[k];
            });
            initStars(); initNodes(); checkUIState();
        }

        // FIXED ENCODING FOR EXPORT/IMPORT
        function safeBtoa(str) { return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1))); }
        function safeAtob(str) { return decodeURIComponent(Array.prototype.map.call(atob(str), (c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); }

        document.getElementById('export-btn').addEventListener('click', () => {
            const jsonString = JSON.stringify(settings);
            const encoded = safeBtoa(jsonString);
            const box = document.getElementById('preset-data');
            box.value = encoded;
            box.focus();
            box.select();
        });

        document.getElementById('import-btn').addEventListener('click', () => {
            try {
                const boxValue = document.getElementById('preset-data').value.trim();
                if(!boxValue) return;
                const decoded = safeAtob(boxValue);
                applySettings(JSON.parse(decoded));
            } catch(e) {
                alert("Import failed: Ensure the code is a valid V17.6.2 preset.");
                console.error(e);
            }
        });

        window.onkeydown = (e) => {
            activeKeys[e.key.toLowerCase()] = true;
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
            if(e.key.toLowerCase() === 'f') { settings.mirrorFlip = !settings.mirrorFlip; applySettings(settings); }
            if(e.key.toLowerCase() === 'q') { applySettings(DEFAULTS); }
            const num = parseInt(e.key);
            if (num >= 1 && num <= 9 && history[num-1]) applySettings(JSON.parse(history[num-1]));
            const isUp = e.key === 'ArrowUp' || e.key === 'ArrowRight', isDown = e.key === 'ArrowDown' || e.key === 'ArrowLeft';
            if(!isUp && !isDown) return;
            const stepMap = { g:'sensitivity', s:'barSpacing', t:'thickness', c:'slices', r:'rotation', z:'zoom', d:'decay' };
            for(let key in stepMap) {
                if(activeKeys[key]) {
                    e.preventDefault();
                    const id = stepMap[key];
                    const el = document.getElementById(id);
                    let val = parseFloat(settings[id]), step = parseFloat(el.step) || 1;
                    if(id === 'slices') step = 1;
                    val = isUp ? val + step : val - step;
                    settings[id] = Math.max(el.min, Math.min(el.max, val));
                    applySettings(settings);
                }
            }
        };
        window.onkeyup = (e) => { activeKeys[e.key.toLowerCase()] = false; };

        document.querySelectorAll('input, select').forEach(el => {
            el.oninput = (e) => {
                settings[e.target.id] = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
                if(document.getElementById(`val-${e.target.id}`)) document.getElementById(`val-${e.target.id}`).innerText = settings[e.target.id];
                if(['slices','baseShape'].includes(e.target.id)) { initStars(); initNodes(); }
                checkUIState();
            };
        });

        async function setup(s) {
            if (currentStream) currentStream.getTracks().forEach(t => t.stop());
            currentStream = s; audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const src = audioCtx.createMediaStreamSource(s); analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048; src.connect(analyser); 
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            timeData = new Uint8Array(analyser.frequencyBinCount);
            isStarted = true;
        }

        document.getElementById('capture-btn').onclick = async () => { try { setup(await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true })); } catch (e) {} };
        document.getElementById('mic-btn').onclick = async () => { try { setup(await navigator.mediaDevices.getUserMedia({ audio: true })); } catch (e) {} };
        document.getElementById('master-reset').onclick = () => { applySettings(DEFAULTS); };

        function hexToRgb(h) { const r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h); return r ? { r: parseInt(r[1], 16), g: parseInt(r[2], 16), b: parseInt(r[3], 16) } : {r:0,g:0,b:0}; }
        function interpolateColor(c1, c2, f) {
            const r1 = hexToRgb(c1), r2 = hexToRgb(c2);
            return `rgb(${Math.round(r1.r+(r2.r-r1.r)*f)}, ${Math.round(r1.g+(r2.g-r1.g)*f)}, ${Math.round(r1.b+(r2.b-r1.b)*f)})`;
        }
        function getColor(index, total, factor) {
            const shift = autoHue;
            const cycleFactor = (Math.sin(shift * 0.05 + factor * 2) + 1) / 2;
            switch(settings.colorMode) {
                case 'rainbow': return `hsl(${(shift + index * 2) % 360}, 80%, 60%)`;
                case 'custom': return interpolateColor(settings.color1, settings.color2, cycleFactor);
                case 'cyber': return interpolateColor("#ff00ff", "#ffcc00", cycleFactor);
                case 'voltage': return interpolateColor("#ffff00", "#0000ff", cycleFactor);
                case 'midnight': return interpolateColor("#2200ff", "#660066", cycleFactor);
                case 'lava': return interpolateColor("#ff0000", "#ffaa00", cycleFactor);
                default: return "#fff";
            }
        }

        function saveToHistory(slot) {
            history[slot] = JSON.stringify(settings);
            document.getElementById(`slot-${slot}`).classList.add('filled');
            localStorage.setItem('viz_history_v1762', JSON.stringify(history));
        }

        const savedHist = localStorage.getItem('viz_history_v1762');
        if(savedHist) {
            history = JSON.parse(savedHist);
            history.forEach((h, i) => { if(h) document.getElementById(`slot-${i}`).classList.add('filled'); });
        }

        window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }; window.onresize();
        btn.onclick = () => { ui.classList.toggle('hidden'); btn.classList.toggle('active'); };
        initStars(); initNodes();

        function draw() {
            requestAnimationFrame(draw);
            if (!dataArray) { dataArray = new Uint8Array(1024); timeData = new Uint8Array(1024); }
            if (isStarted) { analyser.getByteFrequencyData(dataArray); analyser.getByteTimeDomainData(timeData); }
            else { for(let i=0; i<dataArray.length; i++) { dataArray[i] = 40 + Math.sin(Date.now()*0.002 + i*0.02)*40; timeData[i] = 128 + Math.sin(i*0.05)*20; }}

            const sensitivity = parseFloat(settings.sensitivity), avgFreq = (dataArray[0] + dataArray[1] + dataArray[2]) / 3 / 255 * sensitivity;
            const rgb = hexToRgb(settings.bgColor);
            ctx.fillStyle = settings.reactiveBG ? `rgba(${rgb.r*avgFreq}, ${rgb.g*avgFreq}, ${rgb.b*avgFreq}, ${settings.decay})` : `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${settings.decay})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const cx = canvas.width/2, cy = canvas.height/2, complexity = parseInt(settings.slices), baseSpacing = parseFloat(settings.barSpacing), thickness = parseFloat(settings.thickness), flip = settings.mirrorFlip ? -1 : 1;
            autoHue += parseFloat(settings.rainbowSpeed); globalRotation += parseFloat(settings.rotation);
            const limit = Math.floor(dataArray.length * 0.35);

            ctx.save();
            ctx.translate(cx, cy); ctx.scale(settings.zoom, settings.zoom); 
            
            if (settings.baseShape === 'text') {
                const wobble = Math.sin(Date.now() * 0.002) * (0.1 + avgFreq * 0.2);
                const scale = 1 + (avgFreq * 0.5);
                ctx.rotate(wobble); ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.font = `bold ${thickness * 20}px 'Segoe UI'`;
                const iterations = settings.mirrorFlip ? complexity : 1;
                for(let i=0; i<iterations; i++) {
                    const yOffset = settings.mirrorFlip ? (i - (iterations-1)/2) * (baseSpacing * 5) : 0;
                    ctx.save(); ctx.translate(0, yOffset); ctx.scale(scale, scale);
                    ctx.fillStyle = getColor(i, iterations, i/iterations);
                    ctx.fillText(settings.customText, 0, 0); ctx.restore();
                }
            } else if (settings.baseShape === 'neural') {
                ctx.rotate(globalRotation);
                const reach = baseSpacing * 15, beatThick = thickness * (1 + avgFreq * 3);
                nodes.forEach((n, i) => {
                    const fv = dataArray[i % 64] / 255 * sensitivity;
                    n.x += n.vx * (1 + fv * 12); n.y += n.vy * (1 + fv * 12);
                    const b = baseSpacing * 25;
                    if (Math.abs(n.x) > b) n.vx *= -1; if (Math.abs(n.y) > b) n.vy *= -1;
                    nodes.forEach((n2, j) => {
                        if (i >= j) return;
                        const d = Math.sqrt((n.x-n2.x)**2 + (n.y-n2.y)**2);
                        if (d < reach) {
                            ctx.beginPath(); ctx.strokeStyle = getColor(i, nodes.length, i/nodes.length);
                            ctx.lineWidth = beatThick * (1 - d/reach); ctx.globalAlpha = 0.5 + (avgFreq*0.5);
                            ctx.moveTo(n.x, n.y); ctx.lineTo(n2.x, n2.y); ctx.stroke();
                        }
                    });
                });
                nodes.forEach((n, i) => {
                    const fv = dataArray[i % 64] / 255 * sensitivity;
                    ctx.globalAlpha = 1.0; ctx.fillStyle = getColor(i, nodes.length, i/nodes.length);
                    ctx.beginPath(); ctx.arc(n.x, n.y, thickness * (1.2 + fv * 6), 0, Math.PI*2); ctx.fill();
                });
            } else if (settings.baseShape === 'moons') {
                stars.forEach((s, i) => {
                    s.orbit += parseFloat(settings.rotation) * flip;
                    const d = (i / stars.length) * (cx * 0.8) * (baseSpacing/10), m = (dataArray[i % 128]/255) * 50 * sensitivity;
                    ctx.fillStyle = getColor(i, stars.length, i/stars.length);
                    ctx.beginPath(); ctx.arc(Math.cos(s.orbit)*(d+m), Math.sin(s.orbit)*(d+m), (thickness/2)+m/5, 0, Math.PI*2); ctx.fill();
                });
            } else if (settings.baseShape === 'waveform') {
                ctx.rotate(globalRotation); ctx.beginPath(); ctx.lineWidth = thickness;
                const step = (canvas.width / timeData.length) * 2;
                for (let i = 0; i < timeData.length; i++) {
                    const x = (i - timeData.length/2) * step, y = ((timeData[i]-128)/128) * cy * 0.8 * sensitivity * flip;
                    if(i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.strokeStyle = getColor(0, 100, 0.5); ctx.stroke();
            } else if (settings.baseShape === 'kaleidoscope') {
                ctx.rotate(globalRotation);
                for (let i = 0; i < limit; i++) {
                    ctx.strokeStyle = getColor(i, limit, i/limit); ctx.lineWidth = thickness;
                    ctx.save();
                    for (let s = 0; s < complexity; s++) {
                        ctx.rotate((Math.PI * 2) / complexity);
                        ctx.beginPath(); ctx.moveTo(i * ((baseSpacing + thickness * 1.5) * 0.6), 0); 
                        ctx.lineTo(i * ((baseSpacing + thickness * 1.5) * 0.6), (dataArray[i]/2) * sensitivity * flip); ctx.stroke();
                    }
                    ctx.restore();
                }
            } else if (settings.baseShape === 'horizontal') {
                for (let i = 0; i < limit; i += 4) {
                    const m = (dataArray[i]/255) * 250 * sensitivity;
                    const x = (i/limit) * cx * ((baseSpacing + thickness * 1.5)/8);
                    ctx.strokeStyle = getColor(i, limit, i/limit); ctx.lineWidth = thickness;
                    ctx.beginPath(); ctx.moveTo(x, (-m/2)*flip); ctx.lineTo(x, (m/2)*flip); 
                    ctx.moveTo(-x, (-m/2)*flip); ctx.lineTo(-x, (m/2)*flip); ctx.stroke();
                }
            } else {
                ctx.rotate(globalRotation);
                for (let i = 0; i < complexity; i++) {
                    const fIdx = Math.floor((i / complexity) * limit);
                    const size = Math.abs(i * (baseSpacing + thickness * 1.5) + (dataArray[fIdx]/2) * sensitivity * flip);
                    ctx.strokeStyle = getColor(i, complexity, i/complexity); ctx.lineWidth = thickness;
                    ctx.beginPath();
                    if (settings.baseShape === 'circle') ctx.arc(0, 0, size, 0, Math.PI * 2);
                    else if (settings.baseShape === 'square') ctx.rect(-size/2, -size/2, size, size);
                    else if (settings.baseShape === 'hexagon') { for(let h=0; h<6; h++) { const a=(h*Math.PI/3)-Math.PI/2; ctx.lineTo(size*Math.cos(a), size*Math.sin(a)); } ctx.closePath(); }
                    else if (settings.baseShape === 'triangle') { for(let t=0; t<3; t++) { const a=(t*2*Math.PI/3)-Math.PI/2; ctx.lineTo(size*Math.cos(a), size*Math.sin(a)); } ctx.closePath(); }
                    ctx.stroke();
                }
            }
            ctx.restore();
        }
        draw();
    </script>
</body>
</html>
